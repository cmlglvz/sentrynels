---
title: "Correlation Network Analysis"
author: "Lucas Gallart"
edited: "CGA"
output: html_document
---

## Libraries

```{r,echo=FALSE,include=FALSE,warning=FALSE,message=FALSE}
library(tidyverse)
library(psych)
library(igraph)
library(ggpubr)
library(RCy3)
```

After handling and characterizing the data we'll proceed to run a network analysis using Spearman's correlation with a slightly modified script from Lucas Gallart work.

## Relative abundance function

```{r}
rel.abun <- function(data){
  total <- rowSums(data)
  rltv <- data.frame()
  for (x in 1:length(data[,1])) {
    rltv <- rbind(rltv, data[x,]/total[x])
    rltv[is.na(rltv)] <- 0
  }
  final <- data.frame("colMeans.(t)." = colMeans(rltv),"From" = colnames(data))
}
```

## Correlation and data structuring

```{r}
setwd("/Documents/Proyectos_R/sentrynels/Data/Network/")
node_t <- list()
for (y in 1:6) {
  t <- as.data.frame(read.table(str_glue("t{y}.csv"), sep = ";", dec = ".", h = TRUE, row.names = 1))
  abundance <- rel.abun(data = t)
  tcor <- psych::corr.test(t, method = "spearman", adjust = "BH", alpha = .05, ci = FALSE)
  write.table(tcor$r, str_glue("/Documents/Proyectos_R/sentrynels/Data/Network/net_creation/t{y}/tr{y}.csv"), sep = "\t", dec = ".")
  write.table(tcor$p, str_glue("/Documents/Proyectos_R/sentrynels/Data/Network/net_creation/t{y}/tr{y}.csv"), sep = "\t", dec = ".")
  names <- NULL
  datar <- NULL
  datap <- NULL
  for (i in 1:dim(tcor$r)[1]) {
    names <- c(names, paste(rownames(tcor$p)[i], colnames(tcor$p), sep = " - "))
    datar <- c(datar, as.matrix(tcor$r)[i,])
    datap <- c(datap, as.matrix(tcor$p)[i,])
  }
  unionfr <- data.frame(ASV = names, rValue = datar, pValue = datap) %>% 
    dplyr::filter(rValue >= 0.6 | rValue <= -0.6, pValue != 0 & pValue <= 0.05)
  tcytos <- data.frame(From = stringr::str_sub(unionfr[,1], start = 1, end = 7), 
                       to = stringr::str_sub(unionfr[,1], start = 11, end = 17), 
                       rValue = unionfr[,2], pValue = unionfr[,3]) %>% 
    dplyr::filter(!From == to)
  node_t[[y]] <- abundance %>% dplyr::filter(From %in% c(tcytos$From, tcytos$to)) %>% rename("Node" = "From")
  write.table(node_t[[y]],str_glue("/Documents/Proyectos_R/sentrynels/Data/Network/net_creation/t{y}/node_mat_t{y}.csv",sep = "\t",dec = ".",row.names = FALSE))
  write.table(tcytos,str_glue("/Documents/Proyectos_R/sentrynels/Data/Network/net_creation/t{y}/adj_mat_t{y}.csv"),sep = "\t",dec = ".",row.names = FALSE)
}
```

## Node type identification (WORKING HERE)

```{r}
path_u <- cbind(rep("/Documents/Proyectos_R/sentrynels/Data/Network/unique_", 6), c("001", "002", "003", "004", "005", "006"), rep(".csv", 6))
core <- read.table("/Documents/Proyectos_R/sentrynels/Data/Network/ppe.csv", sep = ";", h = FALSE)
shared <- read.table("/Documents/Proyectos_R/sentrynels/Data/Network/shared.csv", sep = ";", h = FALSE)
#other <- read.table("/Documents/Proyectos_R/sentrynels/Data/Network/others.csv", sep = ";", h = FALSE)

node_t_class <- list()
ulist <- list()
for (i in 1:dim(path_u)[1]) {
  ulist[[i]] <- read.table(paste0(path_u[i,1], path_u[i,2], path_u[i,3]), sep = ";", h = FALSE)
  node_t_class[[i]] <- node_t[[i]] %>% 
    dplyr::mutate("Node_Category" = case_when(Node%in%t(ulist[[i]])[,1]~"Unique", 
                                              Node%in%t(core[1,-1])~"Core", 
                                              Node%in%t(shared[1,-1])~"Shared",
                                              TRUE~"Other")
                  )
  write.table(node_t_class[[i]],str_glue("/Documents/Proyectos_R/sentrynels/Data/Network/net_creation/t{i}/node_mat_t{i}.csv"), sep = "\t", dec = ".")
}

par(mfrow = c(2,3))
ASVs <- data.frame("Other" = NA, "Shared" = NA,  "Core" = NA, "Unique" = NA)
for (i in 1:6) {
  plot(table(node_t_class[[i]]$Node_Category), main = path_u[i,2], ylab = "ASVs")
  ASVs[i,] <- table(node_t_class[[i]]$Node_Category)
}
ASVs2 <- ASVs %>% dplyr::mutate(Site = path_u[,2])
write.table(ASVs2, "/Documents/Proyectos_R/sentrynels/Data/Network/net_creation/other_results/ASVs_class.csv", row.names = FALSE)
```

## Igraph object creation

```{r}
gc()
edgelist <- list()
nodelist <- list()
graphlist <- list()
for (x in 1:6) {
  nodelist[[x]] <- read.table(str_glue("/Documents/Proyectos_R/sentrynels/Data/Network/net_creation/t{x}/node_mat_t{x}.csv"), sep = "\t", dec = ".", header = TRUE) %>% relocate(Node)
  data <- read.table(str_glue("/Documents/Proyectos_R/sentrynels/Data/Network/net_creation/t{x}/adj_mat_t{x}.csv"), sep = "\t", dec = ".", header = TRUE)
  #nodelist[[x]] <- node_t_class[[x]]
  edgelist[[x]] <- data %>% select(From, to)
  #nodelist[[x]] <- data %>% pivot_longer(c(From, to)) %>% distinct(value, .keep_all = TRUE) %>% select(value, colMeans..t..,From_type, To_type)
  graphlist[[x]] <- igraph::simplify(graph_from_data_frame(edgelist[[x]], directed = FALSE, vertices = as.data.frame(nodelist[[x]])))
}
```

## Fast analysis

```{r}
#assortativity <- NULL
cc <- NULL
avpath <- NULL
ctance <- NULL
mdeg <- NULL
modul <- NULL
clusters <- NULL
diam <- NULL
size <- NULL
order <- NULL
for (x in 1:6) {
  V(graphlist[[x]])$degree <- degree(graphlist[[x]], mode = c("All"))
  V(graphlist[[x]])$eigen <- evcent(graphlist[[x]])$vector
  V(graphlist[[x]])$betweenness <- betweenness(graphlist[[x]], directed = FALSE)
  values <- as.factor(V(graphlist[[x]])$Tipo)
  #assortativity[x] <- assortativity_nominal(graphlist[[x]], types = values)
  size[x] <- gsize(graphlist[[x]])
  order[x] <- gorder(graphlist[[x]])
  cc[x] <- transitivity(graphlist[[x]], type = "average")
  avpath[x] <- mean_distance(graphlist[[x]], directed = TRUE, unconnected = TRUE)
  ctance[x] <-edge_density(graphlist[[x]], loops = FALSE)
  mdeg[x] <- mean(degree(graphlist[[x]]))
  modul[x] <-modularity(fastgreedy.community(graphlist[[x]], merges = FALSE, modularity = TRUE))
  clusters[x] <- length(fastgreedy.community(graphlist[[x]], merges = FALSE, modularity = TRUE))
  diam[x] <- diameter(graphlist[[x]], directed = FALSE, unconnected = TRUE)

}

path <- c("001", "002", "003", "004", "005", "006")

nets_stats <- data.frame("Connectance" = ctance, 
                         "Average_Degree" = mdeg, 
                         "Diameter" = diam, 
                         "Average_path_length" = avpath, 
                         "Cluster_coefficientt" = cc, 
                         "Modularity" = modul, 
                         "Number_of_clusters" = clusters, 
                         "Nodes" = order, 
                         "Edges" = size, 
                         "Net" = path) %>% relocate(Net)

barplot(nets_stats$Connectance~nets_stats$Net)
barplot(nets_stats$Nodes~nets_stats$Net)
barplot(nets_stats$Average_Degree~nets_stats$Net)
barplot(nets_stats$Average_path_length~nets_stats$Net)
barplot(nets_stats$Modularity~nets_stats$Net)
```

## Network plots

```{r}
sites <- c("ChaÃ±aral", "Flamenco", "Huasco", "Punta Choros", "Quintero", "Las Cruces")
pal <- c("#9CAFB7", "#D9801C", "#02748A" , "#EF233C")
par(mfrow = c(2,3))
for (x in 1:6) {
  set.seed(1000)
  plot(graphlist[[x]], 
       edge.color = "#2B2D42", 
       vertex.label = NA, 
       vertex.color = case_when(vertex_attr(graphlist[[x]], 
                                            "Node_Category") == "Other"~pal[2], 
                                vertex_attr(graphlist[[x]], 
                                            "Node_Category") == "Shared"~pal[3], 
                                vertex_attr(graphlist[[x]], 
                                            "Node_Category") == "Unique"~pal[1], 
                                vertex_attr(graphlist[[x]], 
                                            "Node_Category") == "Core"~pal[4]), 
       vertex_size = log(V(graphlist[[x]])$degree+2), 
       edge.width = 0.1/10000, 
       layout = layout.kamada.kawai, 
       main = sites[x], 
       sub = str_glue("N:{gorder(graphlist[[x]])}  E:{gsize(graphlist[[x]])}"))
}

par(new = FALSE)
```

## Degree plots 

```{r}
nlist <- list(); deg <- list(); top_degs <- list(); plots <- list(); nod <- list(); deg_pre <- list()
for (i in 1:6) {
  nlist[[i]] <- data.frame("Node" = vertex_attr(graphlist[[i]], 
                                                "name"), 
                           "Category" = vertex_attr(graphlist[[i]], 
                                                    "Node_Category"), 
                           "Degree" = vertex_attr(graphlist[[i]], 
                                                  "degree", 
                                                  ),
                           "Net" = path[i],
                           "Size" = gorder(graphlist[[i]])
                           )
 deg_pre[[i]] <- nlist[[i]] %>% 
   filter(Degree <= quantile(Degree, 
                             probs = 0.2))
 deg[[i]] <- as.data.frame(table(deg_pre[[i]]$Category)) %>% 
   mutate("Net" = path[i], 
          "Nodos_upperquantile" = dim(deg_pre[[i]])[1], 
          Proportion = Freq/Nodos_upperquantile, 
          Total = Proportion)
 top_degs[[i]] <- as.data.frame(table(deg[[i]]$Category))
 plots[[i]] <- ggplot(top_degs[[i]], 
                      aes(y = Freq, 
                          x = Var1, 
                          fill = Var1)) + 
   geom_col() + 
   theme_bw()
 nod[[i]] <- as.data.frame(table(nlist[[i]]$Category)) %>% 
   dplyr::mutate("Net" = path[i], 
                 "Size" = gorder(graphlist[[i]]), 
                 Proportion = Freq/Size, 
                 Total = Proportion)
}
degs <- deg
degs[[4]] <- NULL
degs <- degs %>% bind_rows()
deg2 <- deg %>% bind_rows()
ggplot(degs, 
       aes(y = Total, 
           x = Net, 
           fill = factor(Var1, 
                         levels = c("Other", "Unique", "Shared", "Core")
                         )
           )
       ) + 
  geom_col() + 
  scale_fill_manual(name = "ASV Category", 
                    values = c("#D9801C", "#9CAFB7", "#02748A", "#EF233C")
                    )
ggplot(deg2, 
       aes(y = Total, 
           x = Net, 
           fill = factor(Var1, 
                         levels = c("Other", "Unique", "Shared", "Core")
                         )
           )
       ) + 
  geom_col() + 
  scale_fill_manual(name = "ASV Category", 
                    values = c("#D9801C", "#9CAFB7", "#02748A", "#EF233C")
                    )
nods <- nod
nods[[4]] <- NULL
nods <- nod %>% bind_rows()
nod2 <- nod %>% bind_rows()
ggplot(nods, 
       aes(y = Total, 
           x = Net, 
           fill = factor(Var1, 
                         levels = c("Other", "Unique", "Shared", "Cores")
                         )
           )
       ) + 
  geom_col() + 
  scale_fill_manual(name = "ASV Category", 
                    values = c("#D9801C", "#9CAFB7", "#02748A", "#EF233C")
                    )
ggplot(nod2, 
       aes(y = Total, 
           x = Net, 
           fill = factor(Var1, 
                         levels = c("Other", "Unique", "Shared", "Core")
                         )
           )
       ) + 
  geom_col() + 
  scale_fill_manual(name = "ASV Category", 
                    values = c("#D9801C", "#9CAFB7", "#02748A", "#EF233C")
                    )

ggplot(nod2, 
       aes(y = Freq, 
           x = Net, 
           fill = Freq)) + 
  geom_col()
#ggarrange(plots[[1]], plots[[2]], plots[[3]], plots[[4]], plots[[5]], plots[[6]])
```

## Clustering

```{r}
clusts <- NULL
mods <- NULL
for (y in 1:6) {
  fc <- fastgreedy.community(graphlist[[y]], 
                             weights = NULL)
  V(graphlist[[y]])$membership <- fc$membership
  clusts[y] <- length(fc)
  mods[y] <- modularity(graphlist[[y]], 
                        fc$membership)
}
plot(clusters)
plot(mods)
```

## IDK

```{r}
t <- list()
for (y in 1:6) {
  t[[y]] <- as.data.frame(t(read.table(str_glue("t{y}.csv"), sep = ";", dec = ".", header = FALSE, row.names = 1))) %>% 
    dplyr::select(V1)
}
test <- t %>% unlist() %>% inner_join(by = "V1")
```

## Cytoscape integration

```{r}
cytoscapePing()
upgrade_graph(graphlist[[1]])
createNetworkFromIgraph(graphlist[[1]],new.title='Chanaral')
#http://cytoscape.org/RCy3/articles/Network-functions-and-visualization.html
```

```{r}
upgrade_graph(graphlist[[2]])
createNetworkFromIgraph(graphlist[[2]],new.title='Flamenco')
```

```{r}
upgrade_graph(graphlist[[4]])
createNetworkFromIgraph(graphlist[[4]],new.title='Pta_Choros')
```

```{r}
upgrade_graph(graphlist[[5]])
createNetworkFromIgraph(graphlist[[5]],new.title='Quintero')
```

```{r}
upgrade_graph(graphlist[[6]])
createNetworkFromIgraph(graphlist[[6]],new.title='Las_Cruces')
```

## AUX

### Core

```{r}
coregraph <- list()
core.cc <- NULL
core.avpath <- NULL
core.ctance <- NULL
core.mdeg <- NULL
core.modul <- NULL
core.clusters <- NULL
core.diam <- NULL
core.size <- NULL
core.order <- NULL
for (x in 1:6) {
  coregraph[[x]] <- induced_subgraph(graphlist[[x]], 
                                     which(V(graphlist[[x]])$Node_Category == "Core"))
  core.size[x] <- gsize(coregraph[[x]])
  core.order[x] <- gorder(coregraph[[x]])
  core.cc[x] <- transitivity(coregraph[[x]], type = "average")
  core.avpath[x] <- mean_distance(coregraph[[x]], directed = TRUE, unconnected = TRUE)
  core.ctance[x] <-edge_density(coregraph[[x]], loops = FALSE)
  core.mdeg[x] <- mean(degree(coregraph[[x]]))
  core.modul[x] <-modularity(fastgreedy.community(coregraph[[x]], merges = FALSE, modularity = TRUE))
  core.clusters[x] <- length(fastgreedy.community(coregraph[[x]], merges = FALSE, modularity = TRUE))
  core.diam[x] <- diameter(coregraph[[x]], directed = FALSE, unconnected = TRUE)
}

path <- c("Chanaral", "Flamenco", "Huasco", "Pta_Choros", "Quintero", "Las_Cruces")

core_stats <- data.frame("Connectance" = core.ctance, 
                         "Average_Degree" = core.mdeg, 
                         "Diameter" = core.diam, 
                         "Average_path_length" = core.avpath, 
                         "Cluster_coefficientt" = core.cc, 
                         "Modularity" = core.modul, 
                         "Number_of_clusters" = core.clusters, 
                         "Nodes" = core.order, 
                         "Edges" = core.size, 
                         "Net" = path) %>% relocate(Net)
write.csv(core_stats, "/Users/Administrador/Desktop/Camilo/sentrynels/Data/Network/Products/core_stats.csv")
```

### Unique

```{r}
unigraph <- list()
uni.cc <- NULL
uni.avpath <- NULL
uni.ctance <- NULL
uni.mdeg <- NULL
uni.modul <- NULL
uni.clusters <- NULL
uni.diam <- NULL
uni.size <- NULL
uni.order <- NULL
for (x in 1:6) {
  unigraph[[x]] <- induced_subgraph(graphlist[[x]], 
                                     which(V(graphlist[[x]])$Node_Category == "Unique"))
  uni.size[x] <- gsize(unigraph[[x]])
  uni.order[x] <- gorder(unigraph[[x]])
  uni.cc[x] <- transitivity(unigraph[[x]], type = "average")
  uni.avpath[x] <- mean_distance(unigraph[[x]], directed = TRUE, unconnected = TRUE)
  uni.ctance[x] <-edge_density(unigraph[[x]], loops = FALSE)
  uni.mdeg[x] <- mean(degree(unigraph[[x]]))
  uni.modul[x] <-modularity(fastgreedy.community(unigraph[[x]], merges = FALSE, modularity = TRUE))
  uni.clusters[x] <- length(fastgreedy.community(unigraph[[x]], merges = FALSE, modularity = TRUE))
  uni.diam[x] <- diameter(unigraph[[x]], directed = FALSE, unconnected = TRUE)
}

uni_stats <- data.frame("Connectance" = uni.ctance, 
                         "Average_Degree" = uni.mdeg, 
                         "Diameter" = uni.diam, 
                         "Average_path_length" = uni.avpath, 
                         "Cluster_coefficientt" = uni.cc, 
                         "Modularity" = uni.modul, 
                         "Number_of_clusters" = uni.clusters, 
                         "Nodes" = uni.order, 
                         "Edges" = uni.size, 
                         "Net" = path) %>% relocate(Net)
write.csv(uni_stats, "/Users/Administrador/Desktop/Camilo/sentrynels/Data/Network/Products/unique_stats.csv")
```

### Other

```{r}
othgraph <- list()
oth.cc <- NULL
oth.avpath <- NULL
oth.ctance <- NULL
oth.mdeg <- NULL
oth.modul <- NULL
oth.clusters <- NULL
oth.diam <- NULL
oth.size <- NULL
oth.order <- NULL
for (x in 1:6) {
  othgraph[[x]] <- induced_subgraph(graphlist[[x]], 
                                     which(V(graphlist[[x]])$Node_Category == "Other"))
  oth.size[x] <- gsize(othgraph[[x]])
  oth.order[x] <- gorder(othgraph[[x]])
  oth.cc[x] <- transitivity(othgraph[[x]], type = "average")
  oth.avpath[x] <- mean_distance(othgraph[[x]], directed = TRUE, unconnected = TRUE)
  oth.ctance[x] <-edge_density(othgraph[[x]], loops = FALSE)
  oth.mdeg[x] <- mean(degree(othgraph[[x]]))
  oth.modul[x] <-modularity(fastgreedy.community(othgraph[[x]], merges = FALSE, modularity = TRUE))
  oth.clusters[x] <- length(fastgreedy.community(othgraph[[x]], merges = FALSE, modularity = TRUE))
  oth.diam[x] <- diameter(othgraph[[x]], directed = FALSE, unconnected = TRUE)
}

oth_stats <- data.frame("Connectance" = oth.ctance, 
                         "Average_Degree" = oth.mdeg, 
                         "Diameter" = oth.diam, 
                         "Average_path_length" = oth.avpath, 
                         "Cluster_coefficientt" = oth.cc, 
                         "Modularity" = oth.modul, 
                         "Number_of_clusters" = oth.clusters, 
                         "Nodes" = oth.order, 
                         "Edges" = oth.size, 
                         "Net" = path) %>% relocate(Net)
write.csv(oth_stats, "/Users/Administrador/Desktop/Camilo/sentrynels/Data/Network/Products/other_stats.csv")
```

