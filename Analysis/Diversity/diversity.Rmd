---
title: "Diversity"
author: "CGA"
output: html_document
---

## Libraries

```{r,echo=FALSE,include=FALSE}
library(tidyverse)
library(vegan)
```

## Data import

```{r data}
euks_complete <- read.csv("https://raw.githubusercontent.com/cmlglvz/sentrynels/main/Data/Characterization/Eukaryotes_characterization.csv", 
                          header = TRUE, 
                          sep = ";", 
                          dec = ".", 
                          row.names = 1)
```

## Data edition

```{r}
abundance <- euks_complete[,c(3:65)] %>% t() %>% as.data.frame()
taxa <- euks_complete[,-c(3:72)]
```

## Chao1

```{r}

```

### Selected

```{r}
png("/Users/Administrador/Desktop/Camilo/sentrynels/Analysis/Core/Fig_4_selected_upset_intersections_eukaryotes.png", width = 40, height = 17, units = "in", res = 300)
UpSetR::upset(euks_upset, 
              nsets = 6, 
              nintersects = NA, 
              sets = c("Las_Cruces", "Quintero", "Pta_Choros", "Huasco", "Flamenco", "Chanaral"), 
              intersections = list("Las_Cruces", 
                                   "Quintero", 
                                   "Pta_Choros", 
                                   "Huasco", 
                                   "Flamenco", 
                                   "Chanaral", 
                                   list("Chanaral", "Flamenco"), 
                                   list("Huasco", "Pta_Choros"), 
                                   list("Quintero", "Las_Cruces"),
                                   list("Chanaral", "Huasco"), 
                                   list("Chanaral", "Quintero"), 
                                   list("Huasco", "Quintero"), 
                                   list("Flamenco", "Pta_Choros"),
                                   list("Flamenco", "Las_Cruces"), 
                                   list("Pta_Choros", "Las_Cruces"), 
                                   list("Quintero", "Las_Cruces"), 
                                   list("Chanaral", "Huasco", "Quintero"), 
                                   list("Flamenco", "Pta_Choros", "Las_Cruces"), 
                                   list("Chanaral", "Flamenco", "Huasco", "Pta_Choros"), 
                                   list("Chanaral", "Flamenco", "Huasco", "Pta_Choros", "Quintero"), 
                                   list("Chanaral", "Flamenco", "Huasco", "Pta_Choros", "Las_Cruces"), 
                                   list("Chanaral", "Flamenco", "Huasco", "Pta_Choros", "Quintero", "Las_Cruces")
                                   ), 
              empty.intersections = "on", 
              keep.order = TRUE, 
              query.legend = "top", 
              queries = list(list(query = intersects, params = "Chanaral", color = "#FF8811", active = TRUE, query.name = "Unique ChaÃ±aral ASVs"), 
                             list(query = intersects, params = "Flamenco", color = "#F4D06F", active = TRUE, query.name = "Unique Flamenco ASVs"), 
                             list(query = intersects, params = "Huasco", color = "#392F5A", active = TRUE, query.name = "Unique Huasco ASVs"), 
                             list(query = intersects, params = "Pta_Choros", color = "#403286", active = TRUE, query.name = "Unique Punta Choros ASVs"), 
                             list(query = intersects, params = "Quintero", color = "#18E0BD", active = TRUE, query.name = "Unique Quintero ASVs"), 
                             list(query = intersects, params = "Las_Cruces", color = "#80EB9F", active = TRUE, query.name = "Unique Las Cruces ASVs"), 
                             list(query = intersects, params = list("Chanaral", "Flamenco", "Huasco", "Pta_Choros", "Quintero", "Las_Cruces"), color = "#EF233C", active = TRUE, query.name = "Shared ASVs")
                             ), 
              point.size = 3.5, 
              line.size = 1.5, 
              text.scale = 3, 
              mainbar.y.label = "Sites Intersections", 
              sets.x.label = "ASVs per sampling site")
dev.off()
```

## ASV identification

### Core (Shared)

```{r}
core <- euks_upset %>% 
  dplyr::filter(Chanaral == 1 & Flamenco == 1 & Huasco == 1 & Pta_Choros == 1 & Quintero == 1 & Las_Cruces == 1)
core_abundance <- euks_complete[row.names(euks_complete)%in%row.names(core),]
#write.csv2(core_abundance, "/Users/Administrador/Desktop/Camilo/sentrynels/Data/Core/Eukaryotes_core_asv_abundance.csv")
sum(core_abundance[,72])
```

### Uniques per site

```{r}
chanaral <- euks_upset %>% 
  dplyr::filter(Chanaral == 1 & Flamenco == 0 & Huasco == 0 & Pta_Choros == 0 & Quintero == 0 & Las_Cruces == 0)
chanaral_abundance <- euks_complete[row.names(euks_complete)%in%row.names(chanaral),]

flamenco <- euks_upset %>% 
  dplyr::filter(Chanaral == 0 & Flamenco == 1 & Huasco == 0 & Pta_Choros == 0 & Quintero == 0 & Las_Cruces == 0)
flamenco_abundance <- euks_complete[row.names(euks_complete)%in%row.names(flamenco),]

huasco <- euks_upset %>% 
  dplyr::filter(Chanaral == 0 & Flamenco == 0 & Huasco == 1 & Pta_Choros == 0 & Quintero == 0 & Las_Cruces == 0)
huasco_abundance <- euks_complete[row.names(euks_complete)%in%row.names(huasco),]

pta_choros <- euks_upset %>% 
  dplyr::filter(Chanaral == 0 & Flamenco == 0 & Huasco == 0 & Pta_Choros == 1 & Quintero == 0 & Las_Cruces == 0)
ptachoros_abundance <- euks_complete[row.names(euks_complete)%in%row.names(pta_choros),]

quintero <- euks_upset %>% 
  dplyr::filter(Chanaral == 0 & Flamenco == 0 & Huasco == 0 & Pta_Choros == 0 & Quintero == 1 & Las_Cruces == 0)
quintero_abundance <- euks_complete[row.names(euks_complete)%in%row.names(quintero),]

las_cruces <- euks_upset %>% 
  dplyr::filter(Chanaral == 0 & Flamenco == 0 & Huasco == 0 & Pta_Choros == 0 & Quintero == 0 & Las_Cruces == 1)
lascruces_abundance <- euks_complete[row.names(euks_complete)%in%row.names(las_cruces),]
```

### Others (The rest of ASV that are not considered shared or unique)

```{r}
#NOTE: in this point we are subsetting the information directly from abundance table
others <- euks_complete[!row.names(euks_complete)%in%row.names(core),]
others <- others[!row.names(others)%in%row.names(chanaral),]
others <- others[!row.names(others)%in%row.names(flamenco),]
others <- others[!row.names(others)%in%row.names(huasco),]
others <- others[!row.names(others)%in%row.names(pta_choros),]
others <- others[!row.names(others)%in%row.names(quintero),]
others <- others[!row.names(others)%in%row.names(las_cruces),]
```

## Groups abundances

```{r}
asv_types <- read.csv("/Users/Administrador/Desktop/Camilo/sentrynels/Data/Core/Eukaryotes_ASV_type_abundance.csv", 
                      header = TRUE, 
                      sep = ";", 
                      skip = 0) %>% 
  dplyr::rename(Site = X)
asv_types$Site <- factor(asv_types$Site, levels = c("Chanaral", "Flamenco", "Huasco", "Pta_Choros", "Quintero", "Las_Cruces"))
# Transform into long dataframe for ploting
long_types <- reshape2::melt(asv_types[,-5], id.vars = "Site", variable.name = "Type") %>% dplyr::rename(Abundance = value) # you can use pivot_longer() instead
long_types$Type <- factor(long_types$Type, levels = c("Unique", "Other", "Shared"))
```

## Abundances plot

```{r}
aplot <- ggplot(long_types, 
                aes(x = Site, 
                    y = Abundance, 
                    fill = Type)) + 
  geom_bar(position = "fill", stat = "identity") + 
  labs(x = "Sites", 
       y = "Relative Abundance", 
       title = "Relative contribution of eukaryotes ASV grouped by presence at sites") + 
  scale_fill_manual(values = c("#9CAFB7", "#2B2D42", "#EF233C")) + 
  theme_ipsum(base_size = 22, 
              axis_title_size = 25, 
              plot_title_size = 25) + 
  theme(legend.position = "bottom", 
        legend.direction = "horizontal")
ggsave(plot = aplot, 
       filename = "Fig_5_relative_contribution_ASV_eukaryotes_by_type.png", 
       path = "/Users/Administrador/Desktop/Camilo/sentrynels/Analysis/Core/", 
       width = 23, 
       height = 15, 
       dpi = 600)
```

