---
title: "Diversity"
author: "CGA"
output: html_document
---

## Libraries

```{r,echo=FALSE,include=FALSE,warning=FALSE,message=FALSE}
library(tidyverse)
library(vegan)
library(viridis)
library(hrbrthemes)
```

## Data import

```{r data}
euks_complete <- read.csv("https://raw.githubusercontent.com/cmlglvz/sentrynels/main/Data/Characterization/Eukaryotes_characterization.csv", 
                          header = TRUE, 
                          sep = ";", 
                          skip = 0, 
                          row.names = 1)
environmental <- read.csv("https://raw.githubusercontent.com/cmlglvz/sentrynels/main/Data/Diversity/Environmental_data.csv", 
                           header = TRUE, 
                           sep = ";", 
                           dec = ".", 
                           skip = 0,
                           row.names = 1)
environmental$Site <- factor(environmental$Site, levels = as.character(unique(environmental$Site)))
```

## Data edition

```{r}
abundance <- euks_complete[,c(3:65)] %>% t() %>% as.data.frame()
taxa <- euks_complete[,-c(3:72)]
```

## Richness

```{r}
ssenhcir <- with(environmental, specpool(abundance, Site))
richness <- with(environmental, estimateR(abundance, Site)) %>% 
  t() %>% as.data.frame() %>% 
  add_column(Site = environmental$Site, .name_repair = "minimal")
```

### Chao1

```{r}
chao1 <- richness %>% 
  rename("Chao1" = "S.chao1") %>% 
  ggplot(aes(x = Site,
             y = Chao1,
             fill = Site)) + 
  geom_violin(width = 1.2) + 
  geom_boxplot(width = 0.2, 
               color = "grey", 
               alpha = 0.7) + 
  scale_fill_viridis(discrete = TRUE) + 
  geom_jitter(color = "#4C443C", 
              size = 1, 
              alpha = 0.6) +
  theme_ipsum() + 
  theme(legend.position = "none") + 
  ggtitle("Chao1 richness")
ggsave(plot = chao1,
       filename = "Fig_15_chao1_richness.png", 
       path = "/Documents/Proyectos_R/sentrynels/Analysis/Diversity/", 
       width = 15, 
       height = 9, 
       dpi = 600)
```

### ACE

```{r}
ace <- richness %>% 
  rename("ACE" = "S.ACE") %>% 
  ggplot(aes(x = Site,
             y = ACE,
             fill = Site)) + 
  geom_violin(width = 1.2) + 
  geom_boxplot(width = 0.2, 
               color = "grey", 
               alpha = 0.7) + 
  scale_fill_viridis(discrete = TRUE) + 
  geom_jitter(color = "#4C443C", 
              size = 1, 
              alpha = 0.6) +
  theme_ipsum() + 
  theme(legend.position = "none") + 
  ggtitle("ACE richness")
ggsave(plot = ace,
       filename = "Fig_16_ACE_richness.png", 
       path = "/Documents/Proyectos_R/sentrynels/Analysis/Diversity/", 
       width = 15, 
       height = 9, 
       dpi = 600)
```

##Shannon

```{r}
nonnahs <- with(environmental, diversity(abundance, index = "shannon", groups = Site, equalize.groups = FALSE))
shannon <- diversity(abundance, index = "shannon", equalize.groups = FALSE) %>% 
  as.matrix() %>% as.data.frame() %>% add_column(Site = environmental$Site, .name_repair = "minimal") %>% 
  rename("Shannon" = V1)
shplot <- shannon %>% 
  ggplot(aes(x = Site, 
             y = Shannon, 
             fill = Site)) + 
  geom_violin(width = 1.1) + 
  geom_boxplot(width = 0.1, 
               color = "white", 
               alpha = 0.3) + 
  scale_fill_viridis(discrete = TRUE, alpha = 0.8) + 
  geom_jitter(color = "#4C443C", 
              size = 1, 
              alpha = 0.6) + 
  theme_ipsum() + 
  theme(legend.position = "none") + 
  ggtitle("Shannon diversity")
ggsave(plot = shplot,
       filename = "Fig_17_shannon_diversity.png", 
       path = "/Documents/Proyectos_R/sentrynels/Analysis/Diversity/", 
       width = 15, 
       height = 9, 
       dpi = 600)
```

## Simpson

```{r}
nospmis <- with(environmental, diversity(abundance, index = "simpson", groups = Site, equalize.groups = FALSE))
simpson <- diversity(abundance, index = "simpson", equalize.groups = FALSE) %>% 
  as.matrix() %>% as.data.frame() %>% add_column(Site = environmental$Site, .name_repair = "minimal") %>% 
  rename("Simpson" = V1)
simplot <- simpson %>% 
  ggplot(aes(x = Site, 
             y = Simpson, 
             fill = Site)) + 
  geom_violin(width = 1.1) + 
  geom_boxplot(width = 0.1, 
               color = "white", 
               alpha = 0.3) + 
  scale_fill_viridis(discrete = TRUE, alpha = 0.8) + 
  geom_jitter(color = "#4C443C", 
              size = 1, 
              alpha = 0.6) + 
  theme_ipsum() + 
  theme(legend.position = "none") + 
  ggtitle("Simpson diversity")
ggsave(plot = simplot,
       filename = "Fig_18_simpson_diversity.png", 
       path = "/Documents/Proyectos_R/sentrynels/Analysis/Diversity/", 
       width = 15, 
       height = 9, 
       dpi = 600)
```

## Invsimpson

```{r}
vni <- with(environmental, diversity(abundance, index = "invsimpson", groups = Site, equalize.groups = FALSE))
inv <- diversity(abundance, index = "invsimpson", equalize.groups = FALSE) %>% 
  as.matrix() %>% as.data.frame() %>% add_column(Site = environmental$Site, .name_repair = "minimal") %>% 
  rename("Invsimpson" = V1)
iplot <- inv %>% 
  ggplot(aes(x = Site, 
             y = Invsimpson, 
             fill = Site)) + 
  geom_violin(width = 1.1) + 
  geom_boxplot(width = 0.1, 
               color = "white", 
               alpha = 0.3) + 
  scale_fill_viridis(discrete = TRUE, alpha = 0.8) + 
  geom_jitter(color = "#4C443C", 
              size = 1, 
              alpha = 0.6) + 
  theme_ipsum() + 
  theme(legend.position = "none") + 
  ggtitle("Invsimpson diversity")
ggsave(plot = iplot,
       filename = "Fig_19_invsimpson_diversity.png", 
       path = "/Documents/Proyectos_R/sentrynels/Analysis/Diversity/", 
       width = 15, 
       height = 9, 
       dpi = 600)
```

### Alternative

```{r}
unbiased <- simpson.unb(x = abundance) %>% 
  as.matrix() %>% as.data.frame() %>% add_column(Site = environmental$Site, .name_repair = "minimal") %>% 
  rename("Unbiased" = V1)
unbplot <- unbiased %>% 
  ggplot(aes(x = Site, 
             y = Unbiased, 
             fill = Site)) + 
  geom_violin(width = 1.1) + 
  geom_boxplot(width = 0.1, 
               color = "white", 
               alpha = 0.3) + 
  scale_fill_viridis(discrete = TRUE, alpha = 0.8) + 
  geom_jitter(color = "#4C443C", 
              size = 1, 
              alpha = 0.6) + 
  labs(y = "Unbiased Simpson index") + 
  theme_ipsum() + 
  theme(legend.position = "none") + 
  ggtitle("Unbiased simpson richness")
ggsave(plot = unbplot,
       filename = "Fig_20_unbiased_simpson_diversity.png", 
       path = "/Documents/Proyectos_R/sentrynels/Analysis/Diversity/", 
       width = 15, 
       height = 9, 
       dpi = 600)
```


```{r}
aplot <- ggplot(long_types, 
                aes(x = Site, 
                    y = Abundance, 
                    fill = Type)) + 
  geom_bar(position = "fill", stat = "identity") + 
  labs(x = "Sites", 
       y = "Relative Abundance", 
       title = "Relative contribution of eukaryotes ASV grouped by presence at sites") + 
  scale_fill_manual(values = c("#9CAFB7", "#2B2D42", "#EF233C")) + 
  theme_ipsum(base_size = 22, 
              axis_title_size = 25, 
              plot_title_size = 25) + 
  theme(legend.position = "bottom", 
        legend.direction = "horizontal")
ggsave(plot = aplot, 
       filename = "Fig_5_relative_contribution_ASV_eukaryotes_by_type.png", 
       path = "/Users/Administrador/Desktop/Camilo/sentrynels/Analysis/Core/", 
       width = 23, 
       height = 15, 
       dpi = 600)
```

