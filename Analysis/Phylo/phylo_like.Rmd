---
title: "Phylo-like analysis"
author: "CGA"
output: html_document
---

## Libraries

```{r, echo=FALSE,message=FALSE}
library(tidyverse)
library(DECIPHER)
library(Biostrings)
library(dendextend)
library(heatmaply)
library(pheatmap)
library(viridis)
library(vegan)
library(hrbrthemes)
library(htmlwidgets)
```

## Data import

```{r data}
previous <- read.csv("/Documents/Proyectos_R/sentrynels/Data/Phylo/Previous_core_ppe_abundance.csv", 
                     header = TRUE, 
                     sep = ";", 
                     skip = 0,
                     row.names = 1)

core <- read.csv("/Documents/Proyectos_R/sentrynels/Data/PPE/Core_ppe_asv_abundance.csv", 
                 header = TRUE, 
                 sep = ";", 
                 skip = 0, 
                 row.names = 1)

ambiente <- read.csv("~/Desktop/sentrynels/Data/Phylo/HCS_Metal_ambienteironment_NMDS.csv", 
                     header = TRUE, 
                     sep = ";", 
                     dec = ".",
                     skip = 0, 
                     row.names = 1)
```

## Check data

```{r}
print(all(colnames(previous)%in%core$Sequences))
```

Como esto dio TRUE, es copiar y pegar el resto de cosas que hice para avanzar... WIIIII
Las fuentes serÃ¡n Core_Microbiota (y los respectivos markdowns) y los de Metacoder que hice para el ISME

## Data format

```{r}
ambiente$Date <- factor(ambiente$Date, levels = unique(ambiente$Date))
ambiente$Label <- factor(ambiente$Label, levels = unique(ambiente$Label))
ambiente$Site <- factor(ambiente$Site, levels = unique(ambiente$Site))
ambiente$Cu_Level <- factor(ambiente$Cu_Level, levels = unique(ambiente$Cu_Level))

abundance <- core[,-c(1,2,66:81)] %>% t() %>% as.data.frame()
taxa <- core[,-c(3:72)]
write.csv2(taxa, "~/Desktop/sentrynels/Data/Phylo/Taxa_ppe_core.csv")
# I manually checked the file to "fix" the assignation of NA
```

## FASTA file

```{r, echo=FALSE,message=FALSE}
species <- paste(taxa$ASV, taxa$Species, sep = "_")
core_fasta <- data.frame(Names = species, Sequences = taxa$Sequences)
seqRFLP::dataframe2fas(core_fasta, "~/Desktop/sentrynels/Data/Phylo/ppe_core.fasta")
```

Multiple alignment of sequences using the super5 algorithm in MUSCLE v5 (Edgar, year)

## Maximum likelihood

### Dendrogram with maximum likelihood for PPE ASV core sequences

```{r}
malign <- "/Users/Administrador/Desktop/Camilo/sentrynels/Data/Phylo/core_multi_aligned.fasta"
dbConn <-dbConnect(SQLite(), ":memory:")
Seqs2DB(malign, type = "FASTA", dbFile = dbConn, "")
x <- dbGetQuery(dbConn, "select description from Seqs")$description
Add2DB(myData = data.frame(identifier = x, stringsAsFactors = FALSE), dbConn)
consensus <- IdConsensus(dbConn, threshold = 0.3, minInformation = 0.1)
distance.matrix <- DistanceMatrix(consensus, correction = "Jukes-Cantor", processors = NULL, verbose = TRUE)
set.seed(420) # Reproducible results
dendro <- TreeLine(myDistMatrix = distance.matrix, 
                   method = "ML", 
                   showPlot = TRUE, 
                   type = "dendrogram", 
                   myXStringSet = consensus, 
                   processors = NULL, 
                   verbose = TRUE)
dbDisconnect(dbConn)
attributes(dendro)
```
### Dendrogram edition 

```{r}
# Redundant, I know... But it works

iclust <- as.dendrogram(as.hclust(dendro)) %>% dendextend::set("branches_lwd", 0.3) %>% dendextend::ladderize(right = TRUE) 
plot(iclust)
```
## Heatmap

### Data

```{r}
forheat <- abundance
colnames(forheat) <- species
heat_align <- Biostrings::readDNAMultipleAlignment(malign, format = "fasta")
heat_matrix <- as.matrix(heat_align) %>% rownames() %>% as.vector()
print(all(colnames(forheat)%in%gtools::mixedsort(heat_matrix, decreasing = FALSE)))
forheat <- forheat[, rownames(as.matrix(heat_align))]
hellinger <- vegan::decostand(forheat, method = "hellinger")
write.csv2(hellinger, "/Users/Administrador/Desktop/Camilo/sentrynels/Data/Phylo/Hellinger_abundance_ppe_core.csv")
bray_curtis <- vegan::vegdist(hellinger, method = "bray", diag = TRUE)
```

### Plot 

#### Interactive

```{r}
imapheat <- heatmaply::heatmaply(normalize(hellinger), 
                                 Colv = iclust, 
                                 Rowv = NA,
                                 scale_fill_gradient_fun = ggplot2::scale_fill_gradient2(low = "#FFFFFF", 
                                                                                         mid = "#6EA5C9", 
                                                                                         high = "#00308C", 
                                                                                         midpoint = 0.5,
                                                                                         limits = c(0,1)
                                                                                         )
                                 )
saveWidget(imapheat, "./interactive_heatmap_core.html")
```

#### Static

##### Format

```{r}
oclust <- as.dendrogram(as.hclust(dendro)) %>% dendextend::set("branches_lwd", 0.5) %>% dendextend::ladderize(right = FALSE) %>% as.hclust()
sites <- c(rep("Chanaral", 12), rep("Flamenco", 12), rep("Huasco", 12), rep("Pta_Choros", 5), rep("Quintero", 10), rep("Las_Cruces", 12))
mat_row <- data.frame(Sites = sites)
rownames(mat_row) <- rownames(hellinger)
mat_row$Sites <- factor(mat_row$Sites, levels = unique(mat_row$Sites))
divs <- c("STRA", rep("CHLO", 3), rep("STRA", 2), "CHLO", "STRA", "CHLO", "STRA", "HAPT", "STRA", "CHLO", "CRYP", rep("CHLO", 2), "CRYP", rep("STRA", 3), "CRYP", rep("CHLO", 3), rep("HAPT", 2), "CRYP", rep("CHLO", 8), rep("STRA", 4), "CHLO", "HAPT", "KATA", "STRA", "CHLO", "KATA", "CHLO", rep("STRA", 3), "CHLO", "CRYP", "CHLO", "CRYP", "STRA", "NUCL", "CRYP", rep("STRA", 4), "CHLO", "CRYP", rep("CHLO", 3), "STRA", "CRYP", rep("STRA", 2), "NUCL", "CHLO", "STRA", "CRYP", "STRA", rep("CHLO", 2), rep("STRA", 5), "CHLO", rep("NUCL", 2), "STRA", rep("CHLO", 3), "STRA", "CHLO", "STRA", rep("CHLO", 2), rep("STRA", 4), rep("CHLO", 2), "KATA", "CHLO", "CRYP", "STRA", "CHLO", "CRYP", "CHLO")
mat_col <- data.frame(Phylum = divs)
rownames(mat_col) <- colnames(hellinger)
mat_col$Phylum <- factor(mat_col$Phylum, levels = unique(mat_col$Phylum))
mat_colors <- list(Sites = c(Chanaral = "#FF8811", Flamenco = "#F4D06F", Huasco = "#392F5A", Pta_Choros = "#403286", Quintero = "#18E0BD", Las_Cruces = "#80EB9F"), Phylum = c(CRYP = "#6CA6CD", STRA = "#CDAE94", HAPT = "#7EFFD3", CHLO = "#90ED90", NUCL = "#2E4756", KATA = "#C577F9"))
```

##### Plot

```{r}
statheat <- pheatmap(mat = as.matrix(normalize(hellinger)), 
                     color = colorRampPalette(c("#E9F1F7", "#6EA5C9", "#00308C"))(10), 
                     border_color = NA, 
                     show_colnames = FALSE, 
                     show_rownames = FALSE, 
                     drop_levels = FALSE, 
                     cluster_cols = oclust, 
                     cluster_rows = FALSE, 
                     cutree_cols = 6, 
                     annotation_row = mat_row, 
                     annotation_col = mat_col, 
                     annotation_colors = mat_colors, 
                     treeheight_col = 70, 
                     cellheight = NA, 
                     cellwidth = NA, 
                     fontsize = 11, 
                     legend = FALSE, 
                     main = "PPE ASV's core with normalized relative abundance", 
                     filename = "/Documents/Proyectos_R/sentrynels/Fig_14_static_heatmap_core.png", 
                     width = 17, 
                     height = 11, 
                     silent = TRUE)
```


## Extras

### Extract colors from ggplot graphs

```{r}
# To simplify my life when exploring data, NOT FINISHED
xtrct <- function(gg.plot) {
  library(ggplot2)
  library(stringr)
  p <- ggplot_build(gg.plot)
  for (i in 1:length(p$data[[1]])) {
    v <- p$data[[1]][[1]]
    c <- str_sub(v, start = 1, end = -3)
    u <- unique(c)
  } 
  print(u)
}
```

